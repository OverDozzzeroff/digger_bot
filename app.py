import random
import os
from telegram import Update, InlineQueryResultArticle, InputTextMessageContent
from telegram.ext import Application, InlineQueryHandler, CommandHandler
from uuid import uuid4
from flask import Flask, request, jsonify

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "–í–ê–®_–¢–û–ö–ï–ù_–ó–î–ï–°–¨_–î–õ–Ø_–õ–û–ö–ê–õ–¨–ù–û–ì–û_–¢–ï–°–¢–ê")
PORT = int(os.environ.get("PORT", 5000))

# –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ (URL –¥–ª—è –ø—Ä–µ–≤—å—é)
MAIN_PHOTO = "https://tkrim.ru/images/stati/8weJe2QW.jpg"

# –¢–µ–∫—Å—Ç—ã —Ç–∏–ø–æ–≤ –¥–∏–≥–≥–µ—Ä–æ–≤ (19 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
TEXTS = [
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>0% - –≥—Ä—è–∑–Ω—ã–π —á–æ–ø üëÆüèø‚Äç‚ôÇÔ∏è</tg-spoiler>\n\n"
    "‚Ä¢ –î—è–¥–µ–Ω—å–∫–∞ –æ—Ç–ø—É—Å—Ç–∏—Ç–µ –º–µ–Ω—è!\n"
    "‚Ä¢ –ù–µ—Ç, —Ç—ã –æ—Å—Ç–∞–Ω–µ—à—å—Å—è –≥–Ω–∏—Ç—å –≤ –±–æ–º–±–∞—Ä–µ —Å –≥–ø5 –º—É—Ö—ç—Ö—ç—Ö—ç—Ö—ç))\n\n"
    "ü§ñ @Diggerspbdigger",
    # ... (–û—Å—Ç–∞–ª—å–Ω—ã–µ 18 —Ç–∏–ø–æ–≤, —Å <b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> –∏ –Ω–æ–≤—ã–π —Ç–∏–ø "–≠–º–∫–∞")
    # –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤—Å–µ 19 —Ç–∏–ø–æ–≤ –∏–∑ –≤–∞—à–µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>20% - –°—Å—ã–∫—É–Ω üò•</tg-spoiler>\n\n‚Ä¢ –ê –Ω–∞—Å –Ω–µ –ø—Ä–∏–º—É—Ç?\n‚Ä¢ –¢–æ—á–Ω–æ?\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> 67% - –ø–æ–ø—Ä–æ—à–∞–π–∫–∞ –∫–æ—Ä–¥–æ–≤ üó∫Ô∏è\n\n‚Ä¢ –û–≥–æ –∫–∞–∫–æ–π –∫—Ä—É—Ç–Ω–æ–π –±–æ–º–±–∞—Ä—å, –¥–∞–π –∫–æ—Ä–¥—ã\n‚Ä¢ –ù–µ—Ç\n‚Ä¢ –î–∞ –Ω—É –ø–∂ —è –Ω–µ –∫—É–∫–ª–∞ —Å—Ç–æ –ø—Ä–æ—Ü –¥–∞–π –∂–ø–∂–ø–∂–ø–∂–ø–∂–ø–∂–∂–ø–ø!\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> 100% - –ö—Ä—É—Ç—ç–ª—ã–∫ üí∞\n\n‚Ä¢ –í—Å–µ —à–∫–æ–ª—å–Ω–∏–∫–∏ –≤ –æ–∫—Ä—É–≥–µ –ø—Ä–æ—Å—è—Ç —Ç–µ–±—è –æ—Ç–≤–µ–∑—Ç–∏\n–∏—Ö –≤ —Ö–∞–±–∞—Ä–Ω—ã–π –±–± –±–µ–∑ –æ—Ö—Ä–∞–Ω—ã –∏ –Ω–µ –¥–∞–ª–µ–∫–æ –æ—Ç –¥–æ–º–∞\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>50% - –ö—É–∫–ª–∞ üëΩ</tg-spoiler>\n\n‚Ä¢ –Ø –Ω–∞—à–µ–ª –∫—Ä—É—Ç–æ–π —Ä–µ—Å–ø–∏—Ä–∞—Ç–æ—Ä, —ç—Ç–æ —Å–∞–º—ã–π –Ω–æ–≤—ã–π –∏ –∫—Ä—É—Ç—ã–π!\n‚Ä¢ –î–∞–π-–∫–∞ —Å—é–¥–∞! –¢–∞–∫ —ç—Ç–æ –∂–µ –º–æ—á–µ–ø—Ä–∏–µ–º–Ω–∏–∫ –º—É–∂—Å–∫–æ–π...\n‚Ä¢ ...\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>999999999999999% - –ì–ª–∞–≤–Ω—ã–π –¥–∏–≥–≥–µ—Ä –≥–æ—Ä–æ–¥–∞ üôè</tg-spoiler>\n\n‚Ä¢ –ó–Ω–∞–µ—à—å –≥–¥–µ —Å–∫–ª–∞–¥—ã c –≥–ø666, –≥–ø52, –≥–ø67 –∏ –≥–ø1488\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>52.52% - —Ñ—Ä–∏–∫ üé≠</tg-spoiler>\n\n‚Ä¢ –¢—ã –æ—Ç—Å—Ç–∞–ª—ã–π —Ñ—Ä–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç —Å–∞–º—ã–π —Ö–∞–±–∞—Ä–Ω—ã–π –±–± –±–µ–∑ –æ—Ö—Ä–∞–Ω—ã –Ω–æ –±–æ–∏—à—å—Å—è –ª–µ–∑—Ç—å –æ–¥–Ω–æ–º—É\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>14.88% - –∫–∞–ª–æ–ª–∞–∑ üí©</tg-spoiler>\n\n‚Ä¢ –û—á–µ–Ω—å –ª—é–±–∏—à—å –æ–¥–µ–≤–∞—Ç—å –≥–Ω–∏–ª–æ–π –≥–ø5 0 —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞ —Å–≤–æ–π –º–∞–ª–µ–Ω—å–∫–∏–π —Ñ–∏–º–æ–∑–Ω—ã–π –ø–∏—Å—é–Ω –∏ –¥—Ä–æ—á–∏—Ç—å\n‚Ä¢ –•–æ–¥—è—Ç —Å–ª—É—Ö–∏ —á—Ç–æ –æ–¥–Ω–∞–∂–¥—ã —Ç—ã –ø–µ—Ä–µ–ø—É—Ç–∞–ª –±–æ–º–±–∞—Ä—å —Å –±–∏–æ—Ç—É–∞–ª–µ—Ç–æ–º\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>88% - –ú–ï–ì–ê–∫—É–∫–ª–∞ ü§ñ</tg-spoiler>\n\n‚Ä¢ –°–ø–∏–∑–¥–µ–ª —è—â–∏–∫ –≥–ø5 - –º–µ—Å—è—Ü –≥–æ—Ä–µ –Ω–µ –≤–∏–¥–∞—Ç—å!\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>34% - –±–æ–º–∂ üèöÔ∏è</tg-spoiler>\n\n‚Ä¢ - –î—è–¥–µ–Ω—å–∫–∞ –≤—ã, —á—Ç–æ –≤ –±–æ–º–±–∞—Ä–µ –∂–∏–≤–µ—Ç–µ?\n‚Ä¢ - –ê –Ω—É –ø–æ—à–µ–ª –æ—Ç—Å—é–¥–∞! –ì–µ—Ä–º–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –≥–æ–≤–æ—Ä—é!\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>-10% - —Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –ø–æ–¥–¥–æ–º–Ω–∏–∫–∞ üëµ</tg-spoiler>\n\n‚Ä¢ - –û–π, –õ—é–¥–∫–∞ —Å–º–æ—Ä–∏, —á—Ç–æ —ç—Ç–∞ –º–æ–ª–æ–¥–µ–∂ –ø–æ–≥–∞–Ω–Ω–∞—è –¥–µ–ª–∞–µ—Ç!\n‚Ä¢ - –¢–∞–∫ —ç—Ç–æ –∂ –Ω–∞—Ä–∫–æ–º–∞–Ω—ã!\n‚Ä¢ - –£—Ö –≥–∞–¥—ã —ç–¥–∞–∫–∏–µ!\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>78% - –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ ‚úàÔ∏è</tg-spoiler>\n\n‚Ä¢ –û–¥–Ω–∞–∂–¥—ã –ø–æ–µ—Ö–∞–ª –≤ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥ –≤ –ø—É—Å—Ç–æ–π –ø–æ–¥–¥–æ–º–Ω–∏–∫\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>43% - –ª—é–±–∏—Ç–µ–ª—å —Å—Ö–æ–¥–æ–∫ üé™</tg-spoiler>\n\n‚Ä¢ –•–æ–¥–∏—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ö–æ–¥–∫–∏...\n‚Ä¢ - –¢—ã –≥–¥–µ 8 —á–∞—Å–æ–≤ –±—ã–ª?\n‚Ä¢ - –í –¥–µ—Ä–µ–≤–Ω—é –µ–∑–¥–∏–ª –Ω–∞ —Å—Ö–æ–¥–∫—É..\n‚Ä¢ - –¢–∞–∫ –µ–µ –∂–µ –¥–∞–µ –Ω–µ –±—ã–ª–æ\n‚Ä¢ - –ê —Å –∫–µ–º —è —Ç–æ–≥–¥–∞ –≥—É–ª—è–ª...\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>444% - –°—É–ø–µ—Ä –°–£–° ‚ò¢Ô∏è</tg-spoiler>\n\n‚Ä¢ - –í—Å–µ–º –ø—Ä–∏–≤–µ—Ç —Å–µ–≥–æ–¥–Ω—è –º—ã –ø–æ–ª–µ–∑–µ–º –≤ —è–¥–µ—Ä–Ω—ã–π —Ä–µ–∞–∫—Ç–æ—Ä –∞, —Ç–∞–∫–∂–µ –≤ –∑–æ–Ω—É –≥–¥–µ –≤—á–µ—Ä–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –∞—Ç–æ–º–Ω—É—é –±–æ–º–±—É!\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>56% - –ü—É–≥–æ—Ñ–∏–ª–ª üçÜ</tg-spoiler>\n\n‚Ä¢ - –≠–π! –¢—ã –∑–∞—á–µ–º –≤ –ø—Ä–æ—Ç–∏–≤–æ–≥–∞–∑ —Å–≤–æ–π —Ñ–∏–º–æ–∑–∏–∫ –∑–∞–ø–∏—Ö–∞–ª?\n‚Ä¢ - –Ø –≤—Å–µ –æ–±—ä—è—Å–Ω—é... –≠—Ç–æ –Ω–µ —Ç–æ –æ —á–µ–º –≤—ã –ø–æ–¥—É–º–∞–ª–∏...\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>3% - –í–∏—Ä—Ç—É–∞–ª üì±</tg-spoiler>\n\n‚Ä¢ –¢–≤–æ–π –ª—é–±–æ–π –∑–∞–ª–∞–∑ —ç—Ç–æ –∑–∞–ª–∞–∑ –Ω–∞ –¥–∏–≤–∞–Ω –≥–¥–µ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –≤–∏–¥–µ–æ –∫—Ä—É—Ç—ã—Ö –¥–∏–≥–≥–µ—Ä–æ–≤ –∏ –ø—Ä–∏ —ç—Ç–æ–º –¥—Ä–æ—á–∏—à—å\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>23% - –ë–∞—è–Ω–µ—Ä –æ–±—É–∫—Ç–æ–≤ üñçÔ∏è</tg-spoiler>\n\n‚Ä¢ –õ—é–±–∏—Ç —Ä–∏—Å–æ–≤–∞—Ç—å —Ö—É–∏ –Ω–∞ –∑–∞–±—Ä–æ—à–∫–∞—Ö, –∞ –ø–æ—Ç–æ–º –∏—Ö –ª–∏–∑–∞—Ç—å\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>98% - –•–∞–∫–µ—Ä üíª</tg-spoiler>\n\n‚Ä¢ –ú–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ –ª—é–±–æ–π –±–æ–º–±–∞—Ä—å –ø–æ —Ñ–æ—Ç–∫–µ –≥–ø5\n\nü§ñ @Diggerspbdigger",
    "<b>–¢–´ –î–ò–ì–ì–ï–† –ù–ê:</b> <tg-spoiler>14% - –≠–º–∫–∞ üêí</tg-spoiler>\n\n‚Ä¢ –ï–±–ª–∞–Ω –∫–æ—Ç–æ—Ä—ã–π –Ω–∏—Ö—É—è –Ω–µ –º–æ–∂–µ—Ç (—Ä–æ—Ñ–ª)\n\nü§ñ @Diggerspbdigger",
]
# --- (–ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ TEXTS) ---

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask –∏ PTB
app = Application.builder().token(TOKEN).build()
flask_app = Flask(__name__)

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ª–æ–≥–∏–∫–µ) ---

async def start_command(update: Update, context):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    await update.message.reply_text(
        "üëã <b>Digger Level Bot (Webhooks)</b>\n\n"
        "<b>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</b>\n"
        "1. –í –ª—é–±–æ–º —á–∞—Ç–µ\n"
        "2. –í–≤–µ–¥–∏: @username_–±–æ—Ç–∞ –∏ –ø—Ä–æ–±–µ–ª\n"
        "3. –ü–æ—è–≤–∏—Ç—Å—è 'üö∑ –£–∑–Ω–∞–π –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Ç—ã –¥–∏–≥–≥–µ—Ä!' —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.\n"
        "4. **–ù–∞–∂–º–∏** –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É ‚Äî –≤ —á–∞—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è **—Å–ª—É—á–∞–π–Ω—ã–π** —Ç–∏–ø –∏–∑ 19!\n\n"
        "ü§ñ @Diggerspbdigger",
        parse_mode='HTML'
    )

async def inline_handler(update: Update, context):
    query_text = update.inline_query.query.strip()
    
    if query_text == "":
        random_text = random.choice(TEXTS)
        
        message_content = InputTextMessageContent(
            message_text=random_text,
            parse_mode='HTML'
        )
        
        result = InlineQueryResultArticle(
            id=str(uuid4()),
            title="üö∑ –£–∑–Ω–∞–π –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Ç—ã –¥–∏–≥–≥–µ—Ä!",
            description="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –°–õ–£–ß–ê–ô–ù–´–ô —Ç–∏–ø –¥–∏–≥–≥–µ—Ä–∞! (19 —Ç–∏–ø–æ–≤)",
            thumbnail_url=MAIN_PHOTO, 
            input_message_content=message_content,
        )

        await update.inline_query.answer([result], cache_time=0)
        return
    else:
        await update.inline_query.answer([], cache_time=0)


# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ Application
app.add_handler(CommandHandler("start", start_command)) 
app.add_handler(InlineQueryHandler(inline_handler))


# --- –§–£–ù–ö–¶–ò–ò WEBHOCK (–ù–û–í–´–ô –ö–û–î) ---

@flask_app.route('/')
def home():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞."""
    return "Digger Level Bot is running with Webhooks!", 200

@flask_app.route('/webhook', methods=['POST'])
async def webhook():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram."""
    if request.method == "POST":
        # –ü–æ–ª—É—á–∞–µ–º JSON-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        json_data = request.get_json(force=True)
        update = Update.de_json(json_data, app.bot)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é PTB
        await app.process_update(update)
        
        return "ok", 200
    return jsonify({}), 405

# --- –ó–ê–ü–£–°–ö ---

def run_web_server():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Gunicorn."""
    print("--- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook... ---")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Webhook, –∏—Å–ø–æ–ª—å–∑—É—è URL, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π Railway
    WEBHOOK_URL = os.environ.get("RAILWAY_STATIC_URL") or os.environ.get("RAILWAY_PUBLIC_DOMAIN")
    if WEBHOOK_URL:
        full_webhook_url = f"https://{WEBHOOK_URL}/webhook"
        print(f"–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Webhook –Ω–∞: {full_webhook_url}")
        
        # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Webhook –≤ Telegram
        app.bot.set_webhook(url=full_webhook_url)
    else:
        print("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Ä–µ–¥—ã RAILWAY_STATIC_URL –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. Webhook –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
        
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É:", PORT)
    return flask_app

if __name__ == '__main__':
    # –≠—Ç–∞ —á–∞—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    print("–ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ –¥–ª—è Railway)...")
    flask_app.run(debug=True, port=PORT)
